<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pr√ºfungssimulation - Fachinformatiker Lernapp</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .exam-header {
            background: rgba(255, 255, 255, 0.98);
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .exam-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1e3c72;
        }

        .exam-timer {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem 1.5rem;
            background: #f8f9fa;
            border-radius: 50px;
            font-size: 1.25rem;
            font-weight: bold;
        }

        .timer-normal {
            color: #2e7d32;
        }

        .timer-warning {
            color: #f57c00;
            animation: pulse 2s infinite;
        }

        .timer-critical {
            color: #d32f2f;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .exam-container {
            display: flex;
            flex: 1;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            padding: 2rem;
            gap: 2rem;
        }

        .question-nav {
            width: 250px;
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            height: fit-content;
            position: sticky;
            top: 100px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .nav-title {
            font-size: 1.125rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #333;
        }

        .question-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
        }

        .question-btn {
            aspect-ratio: 1;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .question-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .question-btn.current {
            background: #1e3c72;
            color: white;
            border-color: #1e3c72;
        }

        .question-btn.answered {
            background: #e8f5e9;
            border-color: #4caf50;
            color: #2e7d32;
        }

        .question-btn.flagged {
            background: #fff3e0;
            border-color: #ff9800;
            color: #e65100;
        }

        .question-btn.flagged::after {
            content: 'üö©';
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 0.75rem;
        }

        .nav-stats {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e0e0e0;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
        }

        .stat-label {
            color: #666;
        }

        .stat-value {
            font-weight: bold;
            color: #333;
        }

        .exam-content {
            flex: 1;
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e0e0e0;
        }

        .question-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .question-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1e3c72;
        }

        .points-badge {
            padding: 0.25rem 0.75rem;
            background: #e3f2fd;
            color: #1565c0;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .flag-btn {
            padding: 0.5rem 1rem;
            background: white;
            border: 2px solid #ff9800;
            color: #ff9800;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .flag-btn:hover {
            background: #ff9800;
            color: white;
        }

        .flag-btn.flagged {
            background: #ff9800;
            color: white;
        }

        .question-text {
            font-size: 1.25rem;
            line-height: 1.8;
            color: #333;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #1e3c72;
        }

        .answers-container {
            display: grid;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .answer-option {
            display: flex;
            align-items: center;
            padding: 1.25rem;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .answer-option:hover {
            border-color: #1e3c72;
            background: #f5f7ff;
            transform: translateX(5px);
        }

        .answer-option.selected {
            border-color: #1e3c72;
            background: #e3f2fd;
            box-shadow: 0 2px 10px rgba(30, 60, 114, 0.2);
        }

        .answer-radio {
            width: 22px;
            height: 22px;
            margin-right: 1rem;
        }

        .answer-label {
            font-size: 1rem;
            font-weight: 600;
            color: #1e3c72;
            margin-right: 1rem;
        }

        .answer-text {
            flex: 1;
            font-size: 1rem;
            color: #555;
            line-height: 1.5;
        }

        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            padding-top: 1.5rem;
            border-top: 2px solid #e0e0e0;
        }

        .nav-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-prev {
            background: #e0e0e0;
            color: #666;
        }

        .btn-prev:hover:not(:disabled) {
            background: #d0d0d0;
        }

        .btn-next {
            background: #1e3c72;
            color: white;
        }

        .btn-next:hover {
            background: #2a5298;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(30, 60, 114, 0.3);
        }

        .btn-submit {
            background: linear-gradient(135deg, #4caf50, #45a049);
            color: white;
            padding: 1rem 2rem;
            font-size: 1.125rem;
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Exam Setup Modal */
        .modal {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 2.5rem;
            max-width: 500px;
            width: 90%;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-title {
            font-size: 2rem;
            color: #1e3c72;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .exam-rules {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
        }

        .rule-item {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .rule-icon {
            font-size: 1.5rem;
            margin-right: 1rem;
        }

        .rule-text {
            color: #555;
            line-height: 1.5;
        }

        .exam-options {
            margin-bottom: 2rem;
        }

        .option-group {
            margin-bottom: 1.5rem;
        }

        .option-label {
            display: block;
            margin-bottom: 0.5rem;
            color: #666;
            font-weight: 500;
        }

        .option-select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
        }

        .start-exam-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.125rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .start-exam-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 60, 114, 0.4);
        }

        /* Confirmation Modal */
        .confirm-modal {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            max-width: 400px;
            text-align: center;
        }

        .confirm-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .confirm-title {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 1rem;
        }

        .confirm-text {
            color: #666;
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }

        .confirm-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .confirm-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .confirm-cancel {
            background: #e0e0e0;
            color: #666;
        }

        .confirm-submit {
            background: #4caf50;
            color: white;
        }

        /* Results Screen */
        .results-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
        }

        .results-card {
            background: white;
            border-radius: 20px;
            padding: 3rem;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        }

        .results-icon {
            font-size: 5rem;
            margin-bottom: 1.5rem;
        }

        .results-title {
            font-size: 2.5rem;
            color: #333;
            margin-bottom: 1rem;
        }

        .results-score {
            font-size: 4rem;
            font-weight: bold;
            margin-bottom: 2rem;
        }

        .score-excellent {
            color: #4caf50;
        }

        .score-good {
            color: #8bc34a;
        }

        .score-pass {
            color: #ff9800;
        }

        .score-fail {
            color: #f44336;
        }

        .results-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .result-stat {
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .result-stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #1e3c72;
        }

        .result-stat-label {
            font-size: 0.875rem;
            color: #666;
            margin-top: 0.5rem;
        }

        .results-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        .warning-timer {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #ff5722;
            color: white;
            padding: 1.5rem 3rem;
            border-radius: 10px;
            font-size: 1.5rem;
            font-weight: bold;
            z-index: 2000;
            display: none;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translate(-50%, -50%) rotate(0deg); }
            25% { transform: translate(-50%, -50%) rotate(-2deg); }
            75% { transform: translate(-50%, -50%) rotate(2deg); }
        }

        @media (max-width: 1024px) {
            .exam-container {
                flex-direction: column;
            }

            .question-nav {
                width: 100%;
                position: static;
            }

            .question-grid {
                grid-template-columns: repeat(10, 1fr);
            }
        }

        @media (max-width: 768px) {
            .exam-header {
                padding: 1rem;
            }

            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .question-grid {
                grid-template-columns: repeat(6, 1fr);
            }

            .navigation-buttons {
                flex-direction: column;
            }

            .nav-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Exam Header -->
    <div class="exam-header">
        <div class="header-content">
            <div class="exam-title">üéì IHK Pr√ºfungssimulation</div>
            <div class="exam-timer" id="examTimer">
                <span>‚è±Ô∏è</span>
                <span id="timerDisplay">90:00</span>
            </div>
        </div>
    </div>

    <!-- Setup Modal -->
    <div id="setupModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">Pr√ºfung vorbereiten</h2>
            
            <div class="exam-rules">
                <div class="rule-item">
                    <span class="rule-icon">‚è∞</span>
                    <span class="rule-text">90 Minuten Zeitlimit (wie in der echten IHK-Pr√ºfung)</span>
                </div>
                <div class="rule-item">
                    <span class="rule-icon">üìù</span>
                    <span class="rule-text">60 Fragen aus verschiedenen Themenbereichen</span>
                </div>
                <div class="rule-item">
                    <span class="rule-icon">‚ö†Ô∏è</span>
                    <span class="rule-text">Automatische Abgabe bei Zeitablauf</span>
                </div>
                <div class="rule-item">
                    <span class="rule-icon">üéØ</span>
                    <span class="rule-text">Mindestens 50% zum Bestehen erforderlich</span>
                </div>
            </div>

            <div class="exam-options">
                <div class="option-group">
                    <label class="option-label">Pr√ºfungsbereich:</label>
                    <select id="examArea" class="option-select">
                        <option value="ALL">Alle Bereiche (Komplettpr√ºfung)</option>
                        <option value="GANZHEITLICHE_1">Ganzheitliche Aufgabe I</option>
                        <option value="GANZHEITLICHE_2">Ganzheitliche Aufgabe II</option>
                        <option value="WIRTSCHAFT">Wirtschaft und Soziales</option>
                    </select>
                </div>
            </div>

            <button class="start-exam-btn" onclick="startExam()">Pr√ºfung starten</button>
        </div>
    </div>

    <!-- Main Exam Container -->
    <div id="examContainer" class="exam-container" style="display: none;">
        <!-- Question Navigation -->
        <div class="question-nav">
            <h3 class="nav-title">Fragen√ºbersicht</h3>
            <div class="question-grid" id="questionGrid">
                <!-- Question buttons will be generated here -->
            </div>
            <div class="nav-stats">
                <div class="stat-row">
                    <span class="stat-label">Beantwortet:</span>
                    <span class="stat-value" id="answeredCount">0/60</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Markiert:</span>
                    <span class="stat-value" id="flaggedCount">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Verbleibend:</span>
                    <span class="stat-value" id="remainingTime">90:00</span>
                </div>
            </div>
        </div>

        <!-- Question Content -->
        <div class="exam-content">
            <div class="question-header">
                <div class="question-info">
                    <span class="question-number" id="questionNumber">Frage 1</span>
                    <span class="points-badge" id="pointsBadge">3 Punkte</span>
                </div>
                <button class="flag-btn" id="flagBtn" onclick="toggleFlag()">
                    üö© Markieren
                </button>
            </div>

            <div class="question-text" id="questionText">
                L√§dt...
            </div>

            <div class="answers-container" id="answersContainer">
                <!-- Answers will be generated here -->
            </div>

            <div class="navigation-buttons">
                <button class="nav-btn btn-prev" id="prevBtn" onclick="previousQuestion()">
                    ‚Üê Vorherige
                </button>
                <button class="nav-btn btn-next" id="nextBtn" onclick="nextQuestion()">
                    N√§chste ‚Üí
                </button>
                <button class="nav-btn btn-submit" id="submitBtn" onclick="showSubmitConfirmation()" style="display: none;">
                    Pr√ºfung abgeben
                </button>
            </div>
        </div>
    </div>

    <!-- Submit Confirmation Modal -->
    <div id="submitModal" class="modal" style="display: none;">
        <div class="confirm-modal">
            <div class="confirm-icon">‚ö†Ô∏è</div>
            <h3 class="confirm-title">Pr√ºfung abgeben?</h3>
            <p class="confirm-text">
                Du hast <span id="unansweredCount">0</span> unbeantwortete Fragen.
                M√∂chtest du die Pr√ºfung wirklich abgeben?
            </p>
            <div class="confirm-buttons">
                <button class="confirm-btn confirm-cancel" onclick="hideSubmitConfirmation()">
                    Zur√ºck zur Pr√ºfung
                </button>
                <button class="confirm-btn confirm-submit" onclick="submitExam()">
                    Endg√ºltig abgeben
                </button>
            </div>
        </div>
    </div>

    <!-- Results Screen -->
    <div id="resultsContainer" class="results-container" style="display: none;">
        <div class="results-card">
            <div class="results-icon" id="resultsIcon">üéì</div>
            <h2 class="results-title" id="resultsTitle">Pr√ºfung abgeschlossen!</h2>
            <div class="results-score" id="resultsScore">0%</div>
            
            <div class="results-stats">
                <div class="result-stat">
                    <div class="result-stat-value" id="correctAnswers">0</div>
                    <div class="result-stat-label">Richtige Antworten</div>
                </div>
                <div class="result-stat">
                    <div class="result-stat-value" id="totalQuestions">60</div>
                    <div class="result-stat-label">Gesamtfragen</div>
                </div>
                <div class="result-stat">
                    <div class="result-stat-value" id="timeUsed">00:00</div>
                    <div class="result-stat-label">Ben√∂tigte Zeit</div>
                </div>
                <div class="result-stat">
                    <div class="result-stat-value" id="passStatus">-</div>
                    <div class="result-stat-label">Status</div>
                </div>
            </div>

            <div class="results-actions">
                <button class="nav-btn btn-prev" onclick="location.href='/dashboard'">
                    Zum Dashboard
                </button>
                <button class="nav-btn btn-next" onclick="location.reload()">
                    Neue Pr√ºfung
                </button>
            </div>
        </div>
    </div>

    <!-- Warning Timer Popup -->
    <div id="warningTimer" class="warning-timer">
        ‚ö†Ô∏è Nur noch 5 Minuten!
    </div>

    <script>
        // Exam state
        let examSessionId = null;
        let questions = [];
        let currentQuestionIndex = 0;
        let answers = {};
        let flaggedQuestions = new Set();
        let examDuration = 90 * 60; // 90 minutes in seconds
        let timeRemaining = examDuration;
        let timerInterval = null;
        let examStartTime = null;

        function startExam() {
            const examArea = document.getElementById('examArea').value;
            
            // Start exam session via API
            fetch('/api/learning-engine/session/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    userId: 1,
                    sessionType: 'EXAM',
                    topicId: null,
                    questionCount: 60
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.sessionId) {
                    examSessionId = data.sessionId;
                    examStartTime = new Date();
                    
                    // Initialize exam
                    initializeExam();
                    
                    // Hide setup modal, show exam
                    document.getElementById('setupModal').style.display = 'none';
                    document.getElementById('examContainer').style.display = 'flex';
                    
                    // Start timer
                    startTimer();
                    
                    // Generate question grid
                    generateQuestionGrid();
                    
                    // Load first question
                    loadQuestion(0);
                } else {
                    alert('Fehler beim Starten der Pr√ºfung');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Fehler beim Starten der Pr√ºfung');
            });
        }

        function initializeExam() {
            // Initialize 60 questions
            for (let i = 0; i < 60; i++) {
                questions.push({
                    id: i + 1,
                    answered: false
                });
            }
        }

        function generateQuestionGrid() {
            const grid = document.getElementById('questionGrid');
            grid.innerHTML = '';
            
            for (let i = 0; i < 60; i++) {
                const btn = document.createElement('button');
                btn.className = 'question-btn';
                btn.textContent = i + 1;
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `qBtn${i}`;
                
                if (i === 0) {
                    btn.classList.add('current');
                }
                
                grid.appendChild(btn);
            }
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    autoSubmitExam();
                } else if (timeRemaining === 300) { // 5 minutes warning
                    showTimeWarning();
                } else if (timeRemaining <= 300) {
                    document.getElementById('examTimer').className = 'exam-timer timer-critical';
                } else if (timeRemaining <= 900) { // 15 minutes warning
                    document.getElementById('examTimer').className = 'exam-timer timer-warning';
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            document.getElementById('timerDisplay').textContent = display;
            document.getElementById('remainingTime').textContent = display;
        }

        function showTimeWarning() {
            const warning = document.getElementById('warningTimer');
            warning.style.display = 'block';
            setTimeout(() => {
                warning.style.display = 'none';
            }, 3000);
        }

        function loadQuestion(index) {
            currentQuestionIndex = index;
            
            // Update navigation buttons
            updateNavigationButtons();
            
            // Update question grid
            updateQuestionGrid();
            
            // Load question from API
            fetch(`/api/learning-engine/session/${examSessionId}/next`)
                .then(response => response.json())
                .then(data => {
                    if (!data.completed) {
                        displayQuestion(data);
                    }
                })
                .catch(error => {
                    console.error('Error loading question:', error);
                    // Use mock data for demo
                    displayMockQuestion(index);
                });
        }

        function displayMockQuestion(index) {
            const mockQuestions = [
                {
                    question: "Was ist der Unterschied zwischen TCP und UDP?",
                    answerA: "TCP ist verbindungsorientiert, UDP ist verbindungslos",
                    answerB: "TCP ist schneller als UDP",
                    answerC: "UDP garantiert die Zustellung, TCP nicht",
                    answerD: "Es gibt keinen Unterschied",
                    difficulty: 2
                },
                {
                    question: "Welche OSI-Schicht ist f√ºr die Wegfindung zust√§ndig?",
                    answerA: "Transportschicht",
                    answerB: "Netzwerkschicht",
                    answerC: "Sitzungsschicht",
                    answerD: "Anwendungsschicht",
                    difficulty: 2
                }
            ];
            
            const question = mockQuestions[index % mockQuestions.length];
            question.questionId = index + 1;
            displayQuestion(question);
        }

        function displayQuestion(data) {
            // Update question number
            document.getElementById('questionNumber').textContent = `Frage ${currentQuestionIndex + 1}`;
            
            // Update points (mock)
            const points = data.difficulty || 3;
            document.getElementById('pointsBadge').textContent = `${points} Punkte`;
            
            // Display question text
            document.getElementById('questionText').textContent = data.question;
            
            // Display answers
            const container = document.getElementById('answersContainer');
            container.innerHTML = '';
            
            const answerOptions = [
                { label: 'A', text: data.answerA },
                { label: 'B', text: data.answerB },
                { label: 'C', text: data.answerC },
                { label: 'D', text: data.answerD }
            ];
            
            answerOptions.forEach(option => {
                const div = document.createElement('div');
                div.className = 'answer-option';
                div.innerHTML = `
                    <input type="radio" name="answer" class="answer-radio" value="${option.label}" 
                           ${answers[currentQuestionIndex] === option.label ? 'checked' : ''}>
                    <span class="answer-label">${option.label})</span>
                    <span class="answer-text">${option.text}</span>
                `;
                
                if (answers[currentQuestionIndex] === option.label) {
                    div.classList.add('selected');
                }
                
                div.addEventListener('click', function() {
                    selectAnswer(option.label);
                });
                
                container.appendChild(div);
            });
            
            // Update flag button
            updateFlagButton();
        }

        function selectAnswer(answer) {
            answers[currentQuestionIndex] = answer;
            questions[currentQuestionIndex].answered = true;
            
            // Update UI
            document.querySelectorAll('.answer-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            document.querySelectorAll('.answer-option').forEach(opt => {
                if (opt.querySelector('.answer-radio').value === answer) {
                    opt.classList.add('selected');
                    opt.querySelector('.answer-radio').checked = true;
                }
            });
            
            // Update question grid
            updateQuestionGrid();
            updateStats();
            
            // Auto-advance after short delay
            setTimeout(() => {
                if (currentQuestionIndex < 59) {
                    nextQuestion();
                }
            }, 500);
        }

        function toggleFlag() {
            if (flaggedQuestions.has(currentQuestionIndex)) {
                flaggedQuestions.delete(currentQuestionIndex);
            } else {
                flaggedQuestions.add(currentQuestionIndex);
            }
            
            updateFlagButton();
            updateQuestionGrid();
            updateStats();
        }

        function updateFlagButton() {
            const btn = document.getElementById('flagBtn');
            if (flaggedQuestions.has(currentQuestionIndex)) {
                btn.classList.add('flagged');
                btn.innerHTML = 'üö© Markierung entfernen';
            } else {
                btn.classList.remove('flagged');
                btn.innerHTML = 'üö© Markieren';
            }
        }

        function updateQuestionGrid() {
            for (let i = 0; i < 60; i++) {
                const btn = document.getElementById(`qBtn${i}`);
                if (btn) {
                    btn.className = 'question-btn';
                    
                    if (i === currentQuestionIndex) {
                        btn.classList.add('current');
                    }
                    
                    if (questions[i].answered) {
                        btn.classList.add('answered');
                    }
                    
                    if (flaggedQuestions.has(i)) {
                        btn.classList.add('flagged');
                    }
                }
            }
        }

        function updateStats() {
            const answered = questions.filter(q => q.answered).length;
            document.getElementById('answeredCount').textContent = `${answered}/60`;
            document.getElementById('flaggedCount').textContent = flaggedQuestions.size;
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const submitBtn = document.getElementById('submitBtn');
            
            prevBtn.disabled = currentQuestionIndex === 0;
            
            if (currentQuestionIndex === 59) {
                nextBtn.style.display = 'none';
                submitBtn.style.display = 'block';
            } else {
                nextBtn.style.display = 'block';
                submitBtn.style.display = 'none';
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                loadQuestion(currentQuestionIndex - 1);
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < 59) {
                loadQuestion(currentQuestionIndex + 1);
            }
        }

        function jumpToQuestion(index) {
            loadQuestion(index);
        }

        function showSubmitConfirmation() {
            const unanswered = 60 - questions.filter(q => q.answered).length;
            document.getElementById('unansweredCount').textContent = unanswered;
            document.getElementById('submitModal').style.display = 'flex';
        }

        function hideSubmitConfirmation() {
            document.getElementById('submitModal').style.display = 'none';
        }

        function autoSubmitExam() {
            alert('Zeit abgelaufen! Die Pr√ºfung wird automatisch abgegeben.');
            submitExam();
        }

        function submitExam() {
            clearInterval(timerInterval);
            
            // Calculate results
            const answered = questions.filter(q => q.answered).length;
            const timeUsed = examDuration - timeRemaining;
            
            // Submit to API
            if (examSessionId) {
                fetch(`/api/learning-engine/session/${examSessionId}/end`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    showResults(data);
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Show mock results
                    showResults({
                        score: Math.random() * 100,
                        correctAnswers: Math.floor(answered * 0.7),
                        totalQuestions: 60,
                        durationMinutes: Math.floor(timeUsed / 60)
                    });
                });
            }
        }

        function showResults(data) {
            // Hide exam container
            document.getElementById('examContainer').style.display = 'none';
            document.getElementById('submitModal').style.display = 'none';
            
            // Show results
            document.getElementById('resultsContainer').style.display = 'block';
            
            const score = data.score || 0;
            const correctAnswers = data.correctAnswers || 0;
            const timeUsed = data.durationMinutes || 0;
            
            // Update score display
            const scoreElement = document.getElementById('resultsScore');
            scoreElement.textContent = Math.round(score) + '%';
            
            // Set score color based on result
            if (score >= 90) {
                scoreElement.className = 'results-score score-excellent';
                document.getElementById('resultsIcon').textContent = 'üèÜ';
                document.getElementById('resultsTitle').textContent = 'Hervorragend!';
            } else if (score >= 75) {
                scoreElement.className = 'results-score score-good';
                document.getElementById('resultsIcon').textContent = 'üéâ';
                document.getElementById('resultsTitle').textContent = 'Gut gemacht!';
            } else if (score >= 50) {
                scoreElement.className = 'results-score score-pass';
                document.getElementById('resultsIcon').textContent = '‚úÖ';
                document.getElementById('resultsTitle').textContent = 'Bestanden!';
            } else {
                scoreElement.className = 'results-score score-fail';
                document.getElementById('resultsIcon').textContent = 'üìö';
                document.getElementById('resultsTitle').textContent = 'Mehr √ºben!';
            }
            
            // Update stats
            document.getElementById('correctAnswers').textContent = correctAnswers;
            document.getElementById('totalQuestions').textContent = '60';
            document.getElementById('timeUsed').textContent = formatTime(timeUsed * 60);
            document.getElementById('passStatus').textContent = score >= 50 ? 'Bestanden' : 'Nicht bestanden';
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
    </script>
</body>
</html>